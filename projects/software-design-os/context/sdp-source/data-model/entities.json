{
  "entities": [
    {
      "name": "User",
      "description": "The human operator of the tool",
      "fields": [
        {"name": "id", "type": "uuid", "required": true, "description": "Primary key"},
        {"name": "email", "type": "string", "required": true, "description": "User email for auth"},
        {"name": "name", "type": "string", "required": true, "description": "Display name"},
        {"name": "avatarUrl", "type": "string", "required": false, "description": "Profile image URL"},
        {"name": "preferences", "type": "jsonb", "required": false, "description": "UI preferences, default stack, default DB engine"},
        {"name": "createdAt", "type": "datetime", "required": true, "description": "Account creation timestamp"},
        {"name": "updatedAt", "type": "datetime", "required": true, "description": "Last update timestamp"}
      ]
    },
    {
      "name": "AIProviderConfig",
      "description": "Configuration for an AI provider (API key, model preferences). Stored per-user with encrypted keys.",
      "fields": [
        {"name": "id", "type": "uuid", "required": true, "description": "Primary key"},
        {"name": "userId", "type": "uuid", "required": true, "description": "FK to User"},
        {"name": "provider", "type": "enum(anthropic,openai,custom)", "required": true, "description": "AI provider type"},
        {"name": "label", "type": "string", "required": true, "description": "User-friendly name (e.g., 'My Claude Key')"},
        {"name": "apiKeyEncrypted", "type": "string", "required": true, "description": "AES-256 encrypted API key"},
        {"name": "defaultModel", "type": "string", "required": true, "description": "Default model ID (e.g., claude-sonnet-4-5-20250929)"},
        {"name": "baseUrl", "type": "string", "required": false, "description": "Custom base URL for OpenAI-compatible endpoints"},
        {"name": "isDefault", "type": "boolean", "required": true, "description": "Whether this is the default provider for new projects"},
        {"name": "createdAt", "type": "datetime", "required": true, "description": "Creation timestamp"}
      ]
    },
    {
      "name": "Project",
      "description": "A single software design effort moving through the 9-stage pipeline",
      "fields": [
        {"name": "id", "type": "uuid", "required": true, "description": "Primary key"},
        {"name": "userId", "type": "uuid", "required": true, "description": "FK to User (owner)"},
        {"name": "name", "type": "string", "required": true, "description": "Project name"},
        {"name": "slug", "type": "string", "required": true, "description": "URL-safe slug derived from name"},
        {"name": "description", "type": "text", "required": false, "description": "Brief project description"},
        {"name": "currentStage", "type": "integer", "required": true, "description": "Current active stage number (1-9)"},
        {"name": "status", "type": "enum(active,archived,deleted)", "required": true, "description": "Project lifecycle status"},
        {"name": "aiProviderId", "type": "uuid", "required": false, "description": "FK to AIProviderConfig — override for this project"},
        {"name": "templateId", "type": "uuid", "required": false, "description": "FK to Template if created from a template"},
        {"name": "createdAt", "type": "datetime", "required": true, "description": "Creation timestamp"},
        {"name": "updatedAt", "type": "datetime", "required": true, "description": "Last update timestamp"},
        {"name": "deletedAt", "type": "datetime", "required": false, "description": "Soft delete timestamp"}
      ]
    },
    {
      "name": "Stage",
      "description": "One of the 9 pipeline stages for a project. Each stage has a lifecycle: locked → active → generating → review → complete",
      "fields": [
        {"name": "id", "type": "uuid", "required": true, "description": "Primary key"},
        {"name": "projectId", "type": "uuid", "required": true, "description": "FK to Project"},
        {"name": "stageNumber", "type": "integer", "required": true, "description": "Stage position (1-9)"},
        {"name": "stageName", "type": "enum(product,dataModel,database,api,stack,design,sections,infrastructure,export)", "required": true, "description": "Stage identifier"},
        {"name": "stageLabel", "type": "string", "required": true, "description": "Human-readable label (e.g., 'Product Definition')"},
        {"name": "status", "type": "enum(locked,active,generating,review,complete)", "required": true, "description": "Current stage lifecycle status"},
        {"name": "data", "type": "jsonb", "required": false, "description": "The stage's complete data payload — schema varies per stage type"},
        {"name": "userInput", "type": "text", "required": false, "description": "The user's original input for this stage"},
        {"name": "validatedAt", "type": "datetime", "required": false, "description": "When the stage was last validated"},
        {"name": "completedAt", "type": "datetime", "required": false, "description": "When the stage was marked complete"},
        {"name": "createdAt", "type": "datetime", "required": true, "description": "Creation timestamp"},
        {"name": "updatedAt", "type": "datetime", "required": true, "description": "Last update timestamp"}
      ]
    },
    {
      "name": "StageOutput",
      "description": "A versioned output artifact from a stage. Each stage can have multiple versions as the user iterates.",
      "fields": [
        {"name": "id", "type": "uuid", "required": true, "description": "Primary key"},
        {"name": "stageId", "type": "uuid", "required": true, "description": "FK to Stage"},
        {"name": "version", "type": "integer", "required": true, "description": "Version number (auto-incremented per stage)"},
        {"name": "format", "type": "enum(json,md,sql,yaml)", "required": true, "description": "Output file format"},
        {"name": "content", "type": "text", "required": true, "description": "The actual output content"},
        {"name": "generatedBy", "type": "enum(ai,human)", "required": true, "description": "Whether AI generated or human authored"},
        {"name": "aiGenerationId", "type": "uuid", "required": false, "description": "FK to AIGeneration if AI-generated"},
        {"name": "isActive", "type": "boolean", "required": true, "description": "Whether this is the current active version"},
        {"name": "createdAt", "type": "datetime", "required": true, "description": "Creation timestamp"}
      ]
    },
    {
      "name": "AIGeneration",
      "description": "Record of a single AI generation call. Used for cost tracking, audit trail, and prompt iteration history.",
      "fields": [
        {"name": "id", "type": "uuid", "required": true, "description": "Primary key"},
        {"name": "stageId", "type": "uuid", "required": true, "description": "FK to Stage"},
        {"name": "providerId", "type": "uuid", "required": true, "description": "FK to AIProviderConfig"},
        {"name": "model", "type": "string", "required": true, "description": "Model ID used (e.g., claude-sonnet-4-5-20250929)"},
        {"name": "promptTemplate", "type": "string", "required": true, "description": "Name/version of the prompt template used"},
        {"name": "inputTokens", "type": "integer", "required": true, "description": "Number of input tokens"},
        {"name": "outputTokens", "type": "integer", "required": true, "description": "Number of output tokens"},
        {"name": "totalTokens", "type": "integer", "required": true, "description": "Total tokens (input + output)"},
        {"name": "estimatedCost", "type": "decimal", "required": true, "description": "Estimated cost in USD"},
        {"name": "durationMs", "type": "integer", "required": true, "description": "Generation duration in milliseconds"},
        {"name": "status", "type": "enum(success,error,timeout)", "required": true, "description": "Generation result status"},
        {"name": "errorMessage", "type": "text", "required": false, "description": "Error details if status is error/timeout"},
        {"name": "createdAt", "type": "datetime", "required": true, "description": "Timestamp of the generation call"}
      ]
    },
    {
      "name": "Template",
      "description": "Reusable starting point for common product types. Contains pre-filled stage data that gets cloned into a new project.",
      "fields": [
        {"name": "id", "type": "uuid", "required": true, "description": "Primary key"},
        {"name": "name", "type": "string", "required": true, "description": "Template name (e.g., 'SaaS Dashboard')"},
        {"name": "description", "type": "text", "required": true, "description": "What this template provides"},
        {"name": "category", "type": "enum(saas,api,landing,mobile,cli,fullstack,other)", "required": true, "description": "Template category"},
        {"name": "icon", "type": "string", "required": false, "description": "Icon emoji or Lucide icon name"},
        {"name": "stageDefaults", "type": "jsonb", "required": true, "description": "Pre-filled data for each stage"},
        {"name": "isBuiltIn", "type": "boolean", "required": true, "description": "Whether this is a system template vs user-created"},
        {"name": "createdAt", "type": "datetime", "required": true, "description": "Creation timestamp"}
      ]
    },
    {
      "name": "ExportPackage",
      "description": "A generated SDP archive. Tracks each export for download history and validation status.",
      "fields": [
        {"name": "id", "type": "uuid", "required": true, "description": "Primary key"},
        {"name": "projectId", "type": "uuid", "required": true, "description": "FK to Project"},
        {"name": "format", "type": "enum(folder,zip)", "required": true, "description": "Export format"},
        {"name": "validationStatus", "type": "enum(valid,warnings,errors)", "required": true, "description": "Cross-reference validation result"},
        {"name": "validationMessages", "type": "jsonb", "required": false, "description": "Array of validation warnings/errors"},
        {"name": "filePath", "type": "string", "required": true, "description": "Path to the exported package on storage"},
        {"name": "fileSizeBytes", "type": "integer", "required": true, "description": "Package size in bytes"},
        {"name": "exportedAt", "type": "datetime", "required": true, "description": "Export timestamp"}
      ]
    },
    {
      "name": "MCPToken",
      "description": "Bearer token for MCP server access. Scoped to a specific project so agents only see authorized SDPs.",
      "fields": [
        {"name": "id", "type": "uuid", "required": true, "description": "Primary key"},
        {"name": "userId", "type": "uuid", "required": true, "description": "FK to User (owner)"},
        {"name": "projectId", "type": "uuid", "required": true, "description": "FK to Project (scope)"},
        {"name": "tokenHash", "type": "string", "required": true, "description": "SHA-256 hash of the bearer token"},
        {"name": "label", "type": "string", "required": true, "description": "User-friendly label (e.g., 'Claude Code access')"},
        {"name": "lastUsedAt", "type": "datetime", "required": false, "description": "Last time this token was used"},
        {"name": "expiresAt", "type": "datetime", "required": false, "description": "Expiration date (null = never)"},
        {"name": "createdAt", "type": "datetime", "required": true, "description": "Creation timestamp"}
      ]
    }
  ]
}
